 # Define log file path
$LogFile = "C:\lab\logs\Winget_Upgrade_detect.txt"

# Log a message function
function Log-Message {
    param (
        [string]$Message
    )
    $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $FullMessage = "$Timestamp - $Message"
    $FullMessage | Out-File -Append -FilePath $LogFile
}

# Get path for Winget executable
$Winget = ((Get-ChildItem "C:\Program Files\WindowsApps" -Recurse -File | Where-Object { 
    ($_.FullName -match 'C:\\Program Files\\WindowsApps\\Microsoft.DesktopAppInstaller_' -and $_.Name -eq 'winget.exe') 
} | Sort-Object FullName -Descending | Select-Object -First 1).FullName)

# Log Winget path detection
if (-not $Winget) {
    Log-Message "Winget executable not found. Exiting script."
    exit 1
} else {
    Log-Message "Winget executable found at: $Winget"
}

# WinGet version
Log-Message "Retrieving Winget version information..."
& "$Winget" --info 2>&1 | Out-File -Append -FilePath $LogFile

# Update source
Log-Message "Updating Winget sources..."
& "$Winget" source update 2>&1 | Out-File -Append -FilePath $LogFile

# Check for upgrades
Log-Message "Checking for available upgrades..."
$UpgradeOutput = & "$Winget" upgrade 2>&1 | Out-String
$UpgradeOutput | Out-File -Append -FilePath $LogFile

# Evaluate output line count
if (($UpgradeOutput -split "`n").Count -gt 3) {
    Log-Message "Upgrade(s) available. Exiting with code 1."
    exit 1 # Upgrades available
} else {
    Log-Message "No upgrades available. Exiting with code 0."
    exit 0 # No upgrades
}

# Completion log (won't reach here due to exit statements)
Log-Message "Script execution completed." 
